apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- manager.yaml

images:
- digest: sha256:04df1881c5cefde8478ac8e96d24ea8b4a144c303d9b3eed74e8bcbeb9b34981
  name: controller
  newName: registry.redhat.io/rhtas/policy-controller-rhel9-operator

patches:
- path: patches/manager_image_env_patch.yaml
  target:
    kind: Deployment
    name: controller-manager

configMapGenerator:
- behavior: create
  envs:
  - images.env
  name: related-images
  options:
    disableNameSuffixHash: true

replacements:
- source:
    fieldPath: data.RELATED_IMAGE_POLICY_CONTROLLER
    kind: ConfigMap
    name: related-images
    version: v1
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=^manager$].env.[name=^RELATED_IMAGE_POLICY_CONTROLLER$].value
    select:
      kind: Deployment
      name: controller-manager
- source:
    fieldPath: data.RELATED_IMAGE_OSE_CLI
    kind: ConfigMap
    name: related-images
    version: v1
  targets:
  - fieldPaths:
    - spec.template.spec.containers.[name=^manager$].env.[name=^RELATED_IMAGE_OSE_CLI$].value
    select:
      kind: Deployment
      name: controller-manager
